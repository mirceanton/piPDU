---
variables:
  DOCKER_IMAGE: "$DOCKERHUB_USER/pipdu-api-server"
  DOCKER_REGISTRY: registry.hub.docker.com 

before_script:
  - export BUILD_VERSION=$(cat server/src/api-server/VERSION | tr -d '\n')

# =================================================================================================
# Always build the image to see if everything is still building ok
# =================================================================================================
kaniko:build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
  - /kaniko/executor
      --context server/src/api-server
      --dockerfile server/src/api-server/Dockerfile
      --no-push
      --tarPath apiserver.tar
      --destination $DOCKER_REGISTRY/$DOCKER_IMAGE:kaniko-cache # this is ignored due to --no-push
  artifacts:
    paths:
    - apiserver.tar
    when: on_success

# =================================================================================================
# Push a development version of the image on any MR action
# =================================================================================================
crane:push-dev:
  stage: deploy
  image:
    name: gcr.io/go-containerregistry/crane:debug
    entrypoint: [""]
  script:
  - crane auth login -u $DOCKERHUB_USER -p $DOCKERHUB_TOKEN $DOCKER_REGISTRY
  - crane push apiserver.tar $DOCKER_REGISTRY/$DOCKER_IMAGE:$BUILD_VERSION-dev-$CI_PIPELINE_ID
  - crane push apiserver.tar $DOCKER_REGISTRY/$DOCKER_IMAGE:$BUILD_VERSION-dev-latest
  only:
  - merge_requests

# =================================================================================================
# Push a new release version when a tag is created on the main branch
# =================================================================================================
crane:release:
  stage: deploy
  image:
    name: gcr.io/go-containerregistry/crane:debug
    entrypoint: [""]
  script:
  - crane auth login -u $DOCKERHUB_USER -p $DOCKERHUB_TOKEN $DOCKER_REGISTRY
  - crane push apiserver.tar $DOCKER_REGISTRY/$DOCKER_IMAGE:$BUILD_VERSION
  - crane push apiserver.tar $DOCKER_REGISTRY/$DOCKER_IMAGE:latest
  only:
    - tags
  except:
    - branches
