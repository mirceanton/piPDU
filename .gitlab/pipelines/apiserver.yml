---
image: busybox:latest

variables:
  DOCKER_IMAGE: "$DOCKERHUB_USER/api-server"
  DOCKER_REGISTRY: registry.hub.docker.com 

before_script:
  - export BUILD_VERSION=$(cat server/src/api-server/VERSION | tr -d '\n')

docker:build:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
  - /kaniko/executor
      --context server/src/api-server
      --dockerfile server/src/api-server/Dockerfile
      --no-push
      --tarPath apiserver.tar
      --destination $DOCKER_REGISTRY/$DOCKER_IMAGE:dev-$BUILD_VERSION
  artifacts:
    paths:
    - apiserver.tar
    when: on_success

docker:push:
  stage: deploy
  image:
    name: gcr.io/go-containerregistry/crane:debug
    entrypoint: [""]
  script:
  - crane auth login -u $DOCKERHUB_USER -p $DOCKERHUB_TOKEN $DOCKER_REGISTRY
  - crane push apiserver.tar $DOCKER_REGISTRY/$DOCKER_IMAGE:dev-$BUILD_VERSION
  needs:
  - docker:build
